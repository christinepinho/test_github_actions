name: Schemas Should Be Unique
on: pull_request
jobs:
  CheckSchemaUniqueness:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.
      - name: Get dupes
        id: dupes
        run: |
          echo "found_dupes=$(find schema ! -empty -type f -exec basename {} \; -exec sh -c 'md5sum "$1"' _ {} \; | sort | uniq -dD | xargs)" >> $GITHUB_OUTPUT
        shell:
          bash
      - name: Comment PR Found
        uses: thollander/actions-comment-pull-request@v2
        if: steps.dupes.outputs.found_dupes
        with:
          message: |
            :warning: Duplicate schema names found in the repo
      - name: Get changed files
        id: changed-files
        uses:
          tj-actions/changed-files@v37
        with:
          files: schema/**
      - name: Check filename matches schemaname
        id: matches
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "filename=$($file | grep -oE '(.+)@' | grep -oE '([^/]+)@' | rev | cut -c 2- | rev)"
            echo "name=$(jq '.name' $file)"
            if [ $filename != $name ]
               then
               echo "matches=found" >> $GITHUB_OUTPUT
            fi
          done
      - name: Comment PR Found
        uses: thollander/actions-comment-pull-request@v2
        if: steps.matches.outputs.matches
        with:
          message: |
            :warning: Schema name in file does not match file name
    
